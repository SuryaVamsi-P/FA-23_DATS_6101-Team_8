```{r}
library(ROSE)
library(caret)  # For data partitioning
# Convert object type columns to factors if they are categorical
g[ ,sapply(g, is.character)] <- lapply(g[ ,sapply(g, is.character)], as.factor)

# Assuming 'hospital_death' is your target variable
set.seed(123)  # For reproducibility

# Split the data into training and testing sets
splitIndex <- createDataPartition(g$hospital_death, p = .80, list = FALSE, times = 1)
training_set <- g[splitIndex, ]
testing_set <- g[-splitIndex, ]

# Apply ROSE to the training set for balancing
rose_data <- ROSE(hospital_death ~ ., data = training_set, seed = 1)$data

# Check the balance of the target variable after applying ROSE
table(rose_data$hospital_death)

# Now, you can proceed with model training using the rose_data

```



```{r}
selected_columns <- c("hospital_death", "arf_apache", "intubated_apache", "ventilated_apache", "aids", "cirrhosis", "diabetes_mellitus", "hepatic_failure", "immunosuppression", "leukemia", "lymphoma", "solid_tumor_with_metastasis",  "elective_surgery", "apache_post_operative",
 "heart_rate_apache",         "temp_apache",               "d1_diasbp_min",             "d1_diasbp_noninvasive_min",
  "d1_heartrate_max",          "d1_mbp_min",                "d1_mbp_noninvasive_min",    "d1_resprate_max",          
 "d1_spo2_min",               "d1_sysbp_min",              "d1_sysbp_noninvasive_min",  "d1_temp_min",              
 "h1_diasbp_min",             "h1_diasbp_noninvasive_min", "h1_heartrate_max",          "h1_mbp_min",               
 "h1_mbp_noninvasive_min",    "h1_resprate_max",           "h1_resprate_min",           "h1_spo2_min",              
 "h1_sysbp_min",              "h1_sysbp_noninvasive_min",  "d1_bun_max",                "d1_bun_min",               
 "d1_calcium_min",            "d1_creatinine_max",         "d1_creatinine_min",         "d1_hco3_max",              
 "d1_hco3_min",               "d1_potassium_max",          "d1_wbc_max",                "d1_wbc_min", "map_apache", "bmi",  "gcs_eyes_apache", "gcs_motor_apache", "gcs_unable_apache", "gcs_verbal_apache"  )

# Create a new dataframe with selected columns
new_dataframe4 <- rose_data[, selected_columns, drop = FALSE]
```

```{r}

categorical_columns <- c("ethnicity", "gender", "hospital_admit_source", "icu_admit_source", "apache_3j_bodysystem", "apache_2_bodysystem", "icu_stay_type", "icu_type")

# Encode categorical variables using one-hot encoding
encoded_data2 <- model.matrix(~ . - 1, data = rose_data[, categorical_columns])

# Convert the encoded data to a data frame
encoded_data2 <- as.data.frame(encoded_data2)


# Append non-categorical columns to the encoded data
new_dataframe4 <- cbind(new_dataframe4, encoded_data2)
```

```{r}
split_index <- createDataPartition(new_dataframe4$hospital_death, p = 0.8, list = FALSE)
training_data3 <- new_dataframe4[split_index, ]
testing_data3 <- new_dataframe4[-split_index, ]

```


```{r}

library(rpart)

# Convert 'hospital_death' to a factor
training_data3$hospital_death <- as.factor(training_data3$hospital_death)
testing_data3$hospital_death <- as.factor(testing_data3$hospital_death)

# Build a decision tree model
model_tree <- rpart(hospital_death ~ ., data = training_data3, method = "class")

# Make predictions on the testing data
predictions_tree <- predict(model_tree, newdata = testing_data3, type = "class")

# Print the confusion matrix
conf_matrix_tree <- table(predictions_tree, testing_data3$hospital_death)
print("Confusion Matrix:")
print(conf_matrix_tree)

# Calculate and print accuracy
accuracy_tree <- sum(diag(conf_matrix_tree)) / sum(conf_matrix_tree)
cat("Accuracy:", accuracy_tree, "\n")

```




```{r}
library(caret)
library(rpart)

# Ensure all column names are valid
names(training_data3) <- make.names(names(training_data3), unique = TRUE)

# Check for NA values
if (any(is.na(training_data3))) {
    stop("NA values found in training_data3")
}

# Define the control parameters for training with a basic setup
fitControl <- trainControl(method = "cv", number = 10)

# Use a basic grid for tuning
grid <- expand.grid(.cp = seq(0.01, 0.05, by = 0.02))

# Fit a simpler model
set.seed(123)
tuned_model <- train(hospital_death ~ ., 
                     data = training_data3, 
                     method = "rpart",
                     trControl = fitControl,
                     tuneGrid = grid)

# Print the results
print(tuned_model)


```